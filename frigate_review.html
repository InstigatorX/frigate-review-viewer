<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Frigate Daily Log Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #020617;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #0f172a, #020617);
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    h1 {
      margin: 0 0 0.5rem;
      font-size: 1.7rem;
      font-weight: 600;
    }

    .subtitle {
      margin-bottom: 1.25rem;
      color: #9ca3af;
      font-size: 0.95rem;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding: 0.75rem 0.9rem;
      border-radius: 0.9rem;
      background: rgba(15,23,42,0.9);
      border: 1px solid #1f2937;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    label {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    input[type="date"], select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #374151;
      padding: 0.3rem 0.7rem;
      color: #e5e7eb;
      font-size: 0.8rem;
      outline: none;
    }

    input[type="date"]:focus, select:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.4);
    }

    .btn-secondary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      white-space: nowrap;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      background: #020617;
      transition: opacity 0.1s ease, transform 0.1s ease, box-shadow 0.1s ease;
    }

    .btn-secondary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(15,23,42,0.7);
    }

    .btn-secondary:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .quick-ranges {
      display: flex;
      gap: 0.4rem;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      background: rgba(15,23,42,0.7);
    }

    .quick-ranges-label {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-right: 0.25rem;
    }

    .status {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-left: auto;
      min-width: 160px;
      text-align: right;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
      gap: 1rem;
    }

    .card {
      background: radial-gradient(circle at top left, #1f2937, #020617);
      border-radius: 0.9rem;
      padding: 0.75rem;
      border: 1px solid #111827;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .thumb-wrapper {
      position: relative;
      border-radius: 0.7rem;
      overflow: hidden;
      background: #020617;
      aspect-ratio: 16 / 9;
    }

    .thumb-wrapper[data-video-url] {
      cursor: pointer;
    }

    .thumb-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.15s ease, filter 0.15s ease;
    }

    .thumb-wrapper[data-video-url]:hover img {
      transform: scale(1.02);
      filter: brightness(1.05);
    }

    .thumb-wrapper video {
      width: 100%;
      height: 100%;
      display: block;
      background: #000;
    }

    .chip-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.25rem;
      gap: 0.5rem;
      font-size: 0.8rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #111827;
      border: 1px solid #1f2937;
      color: #9ca3af;
      white-space: nowrap;
    }

    .title {
      font-size: 1rem;
      font-weight: 600;
    }

    .scene {
      font-size: 0.82rem;
      line-height: 1.4;
      color: #d1d5db;
      max-height: 4.2em;
      overflow: hidden;
    }

    .objects {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    .empty-message {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-top: 1rem;
    }

    .pagination {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.75rem;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .page-info {
      min-width: 110px;
      text-align: center;
    }

    @media (max-width: 700px) {
      .controls-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .status {
        margin-left: 0;
        text-align: left;
      }

      .page {
        padding: 1rem;
      }

      h1 {
        font-size: 1.4rem;
      }

      .pagination {
        justify-content: center;
      }

      .quick-ranges {
        width: 100%;
        justify-content: flex-start;
        margin-top: 0.25rem;
      }
    }
  </style>
  <!-- HLS.js for inline HLS playback -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
<div class="page">
  <h1>Frigate Daily Log Viewer</h1>
  <div class="subtitle">
    Viewing events from local markdown log files generated by your Frigate script.
  </div>

  <div class="controls">
    <!-- Row 1: date picker, quick ranges, status -->
    <div class="controls-row">
      <label for="logDate">Log date:</label>
      <input type="date" id="logDate" />

      <div class="quick-ranges">
        <span class="quick-ranges-label">Quick range:</span>
        <button id="btnToday" class="btn-secondary" type="button">Today</button>
        <button id="btnYesterday" class="btn-secondary" type="button">Yesterday</button>
        <button id="btn7Days" class="btn-secondary" type="button">Last 7 days</button>
      </div>

      <div id="statusText" class="status">Idle</div>
    </div>

    <!-- Row 2: camera, threat level, severity, objects, per page -->
    <div class="controls-row">
      <label for="cameraFilter">Camera:</label>
      <select id="cameraFilter">
        <option value="all">All Cameras</option>
      </select>

      <label for="threatFilter">Min Threat Level:</label>
      <select id="threatFilter">
        <option value="all">All</option>
        <option value="0">0 – Low+</option>
        <option value="1">1 – Medium+</option>
        <option value="2">2 – High only</option>
      </select>

      <label for="eventSeverityFilter">Event Severity:</label>
      <select id="eventSeverityFilter">
        <option value="all">All Severities</option>
      </select>

      <label for="objectsFilter">Objects:</label>
      <select id="objectsFilter">
        <option value="all">All Objects</option>
      </select>

      <label for="pageSizeSelect">Per page:</label>
      <select id="pageSizeSelect">
        <option value="12">12</option>
        <option value="24">24</option>
        <option value="48">48</option>
      </select>
    </div>
  </div>

  <div id="eventsContainer" class="grid"></div>
  <div id="emptyMessage" class="empty-message"></div>

  <div id="paginationControls" class="pagination">
    <button id="prevPage" class="btn-secondary" type="button">Prev</button>
    <span id="pageInfo" class="page-info"></span>
    <button id="nextPage" class="btn-secondary" type="button">Next</button>
  </div>
</div>

<script>
  const logDateInput        = document.getElementById("logDate");
  const statusText          = document.getElementById("statusText");
  const eventsContainer     = document.getElementById("eventsContainer");
  const emptyMessage        = document.getElementById("emptyMessage");
  const cameraFilter        = document.getElementById("cameraFilter");
  const threatFilter        = document.getElementById("threatFilter");
  const eventSeverityFilter = document.getElementById("eventSeverityFilter");
  const objectsFilter       = document.getElementById("objectsFilter");
  const pageSizeSelect      = document.getElementById("pageSizeSelect");
  const prevPageBtn         = document.getElementById("prevPage");
  const nextPageBtn         = document.getElementById("nextPage");
  const pageInfoSpan        = document.getElementById("pageInfo");
  const btnToday            = document.getElementById("btnToday");
  const btnYesterday        = document.getElementById("btnYesterday");
  const btn7Days            = document.getElementById("btn7Days");

  let lastEvents = [];
  let currentPage = 1;
  let pageSize = parseInt(pageSizeSelect.value, 10) || 12;
  // rangeMode: "single" or "7days"
  let rangeMode = "single";

  function getTodayString() {
    const t = new Date();
    const y = t.getFullYear();
    const m = String(t.getMonth() + 1).padStart(2, "0");
    const d = String(t.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function getOffsetDateString(offsetDays) {
    const t = new Date();
    t.setDate(t.getDate() + offsetDays);
    const y = t.getFullYear();
    const m = String(t.getMonth() + 1).padStart(2, "0");
    const d = String(t.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  logDateInput.value = getTodayString();

  function getLogFileName(dateStr) {
    return `frigate_${dateStr}.log`;
  }

  function getEpochRangeForDate(dateStr) {
    const [y, m, d] = dateStr.split("-").map(Number);
    const startDate = new Date(y, m-1, d, 0, 0, 0);
    const endDate   = new Date(y, m-1, d, 23, 59, 59);
    return {
      start: Math.floor(startDate.getTime()/1000),
      end:   Math.floor(endDate.getTime()/1000)
    };
  }

  function parseMarkdownLink(line) {
    const m = line.match(/\[([^\]]+)\]\(([^)]+)\)/);
    return m ? {text:m[1], url:m[2]} : null;
  }

  function parseMarkdownImage(line) {
    const m = line.match(/!\[([^\]]*)\]\(([^)]+)\)/);
    return m ? {alt:m[1], url:m[2]} : null;
  }

  function abbreviateDay(str) {
    const map = {
      Monday:"Mon", Tuesday:"Tue", Wednesday:"Wed",
      Thursday:"Thu", Friday:"Fri", Saturday:"Sat", Sunday:"Sun"
    };
    const parts = str.split(",");
    if (parts.length < 2) return str;
    const day = parts[0].trim();
    return `${map[day]||day}, ${parts.slice(1).join(",").trim()}`;
  }

  // Normalize VOD URLs to HTTPS reverse proxy for Safari / mixed-content safety
  function normalizeVideoUrl(url) {
    try {
      const u = new URL(url);
      if (u.pathname.startsWith("/vod/")) {
        return "https://nvr.loebees.com:8971" + u.pathname;
      }
      return url;
    } catch (e) {
      console.warn("Could not normalize video URL:", url, e);
      return url;
    }
  }

  function parseLogContent(raw) {
    let lines = raw.split("\n").map(l => l.trim());
    if (lines.length >= 2) lines = lines.slice(2);
    const blocks = lines.join("\n").split(/\n\s*\n/);
    const events = [];

    for (const block of blocks) {
      const ls = block.split("\n").map(l => l.trim()).filter(l => l);
      if (!ls.length) continue;

      let index=null, time="", camera="";
      let threat=0, eventSeverity="", objectsList=[];
      let title="", scene="", thumbUrl="", videoUrl="", previewUrl="";

      // Header line: "49.   Tuesday, 10:52 AM - front_door"
      const header = ls[0];
      const parts = header.split(/\s[-–]\s/);
      if (parts.length >= 2) {
        const left = parts[0];
        const right = parts[1];
        const m = left.match(/^(\d+)\.\s*(.*)$/);
        if (m) {
          index = parseInt(m[1], 10);
          time = abbreviateDay(m[2].trim());
        }
        camera = right.trim();
      }

      let sceneStartIndex = 1;

      for (let i = 1; i < ls.length; i++) {
        const line = ls[i];

        // Threat:N
        const t = line.match(/^Threat:\s*([0-9]+)/i);
        if (t) {
          threat = Math.min(2, Math.max(0, parseInt(t[1], 10)));
          sceneStartIndex = Math.max(sceneStartIndex, i + 1);
          continue;
        }

        // Severity:alert
        const s = line.match(/^Severity:\s*([A-Za-z0-9_-]+)/i);
        if (s) {
          eventSeverity = s[1].toLowerCase();
          sceneStartIndex = Math.max(sceneStartIndex, i + 1);
          continue;
        }

        // Objects:person, person-verified, car
        const o = line.match(/^Objects:\s*(.*)$/i);
        if (o) {
          objectsList = o[1]
            .split(",")
            .map(v => v.trim().toLowerCase())
            .filter(v => v);
          sceneStartIndex = Math.max(sceneStartIndex, i + 1);
          continue;
        }

        if (parseMarkdownLink(line) || parseMarkdownImage(line)) {
          break;
        }
      }

      // Title link
      for (let i = sceneStartIndex; i < ls.length; i++) {
        const link = parseMarkdownLink(ls[i]);
        if (link) {
          title = link.text;
          videoUrl = normalizeVideoUrl(link.url);
          break;
        }
      }

      // Scene
      for (let i = sceneStartIndex; i < ls.length; i++) {
        const l = ls[i];
        if (/^Threat:/i.test(l)) continue;
        if (/^Severity:/i.test(l)) continue;
        if (/^Objects:/i.test(l)) continue;
        if (parseMarkdownLink(l) || parseMarkdownImage(l)) continue;
        if (!scene) { scene = l; break; }
      }

      // Thumbnail
      for (let i = sceneStartIndex; i < ls.length; i++) {
        const img = parseMarkdownImage(ls[i]);
        if (img) { thumbUrl = img.url; break; }
      }

      // Video/Preview line (usually last)
      const last = ls[ls.length-1];
      const links = [...last.matchAll(/\[([^\]]+)\]\(([^)]+)\)/g)];
      for (const l of links) {
        const label = l[1].toLowerCase();
        const url = l[2];
        if (label.includes("video"))  videoUrl   = normalizeVideoUrl(url);
        if (label.includes("preview")) previewUrl = url;
      }

      events.push({
        index, time, camera, threat, eventSeverity, objectsList,
        title, scene, thumbUrl, videoUrl, previewUrl
      });
    }

    return events;
  }

  function updateCameraOptions(events) {
    const cams = [...new Set(events.map(e=>e.camera))].sort();
    cameraFilter.innerHTML = '<option value="all">All Cameras</option>';
    cams.forEach(c=>{
      cameraFilter.innerHTML += `<option value="${c}">${c}</option>`;
    });
  }

  function updateSeverityOptions(events) {
    const sevs = [...new Set(events.map(e=>e.eventSeverity).filter(Boolean))].sort();
    eventSeverityFilter.innerHTML = '<option value="all">All Severities</option>';
    sevs.forEach(s=>{
      eventSeverityFilter.innerHTML += `<option value="${s}">${s}</option>`;
    });
  }

  function updateObjectsOptions(events) {
    const objs = new Set();
    events.forEach(e=>e.objectsList.forEach(o=>objs.add(o)));
    objectsFilter.innerHTML = '<option value="all">All Objects</option>';
    [...objs].sort().forEach(o=>{
      objectsFilter.innerHTML += `<option value="${o}">${o}</option>`;
    });
  }

  function applyFilters(events) {
    let res = events;

    const cam = cameraFilter.value;
    if (cam !== "all") {
      res = res.filter(e => e.camera === cam);
    }

    const t = threatFilter.value;
    if (t !== "all") {
      res = res.filter(e => e.threat >= parseInt(t, 10));
    }

    const sev = eventSeverityFilter.value;
    if (sev !== "all") {
      res = res.filter(e => (e.eventSeverity || "") === sev);
    }

    const obj = objectsFilter.value;
    if (obj !== "all") {
      res = res.filter(e => e.objectsList.includes(obj));
    }

    return res;
  }

  function setupThumbnailClickHandlers() {
    const wrappers = document.querySelectorAll(".thumb-wrapper[data-video-url]");
    wrappers.forEach(wrapper => {
      const url = wrapper.dataset.videoUrl;
      if (!url) return;

      wrapper.addEventListener("click", () => {
        // If a video already exists, toggle play/pause
        const existingVideo = wrapper.querySelector("video");
        if (existingVideo) {
          if (existingVideo.paused) existingVideo.play();
          else existingVideo.pause();
          return;
        }

        wrapper.innerHTML = "";
        const video = document.createElement("video");
        video.controls = true;
        video.autoplay = true;
        video.playsInline = true;

        video.addEventListener("error", (e) => {
          console.error("Video playback error for", url, e, video.error);
        });

        if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = url;
        } else if (window.Hls && window.Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(video);
        } else {
          video.src = url;
        }

        wrapper.appendChild(video);
      });
    });
  }

  function renderCards(events) {
    eventsContainer.innerHTML = "";
    emptyMessage.textContent = "";

    if (!events.length) {
      emptyMessage.textContent = "No events found.";
      return;
    }

    for (const ev of events) {
      const card = document.createElement("div");
      card.className = "card";

      const objectsDisplay = ev.objectsList.length
        ? `<div class="objects">Objects: ${ev.objectsList.join(", ")}</div>`
        : "";

      const wrapperAttrs = ev.videoUrl ? ` data-video-url="${ev.videoUrl}"` : "";
      const thumbInner = ev.thumbUrl
        ? `<img src="${ev.thumbUrl}" title="${ev.scene.replace(/"/g,'&quot;')}">`
        : "";

      const thumbBlock = thumbInner.trim()
        ? `<div class="thumb-wrapper"${wrapperAttrs}>${thumbInner}</div>`
        : "";

      card.innerHTML = `
        ${thumbBlock}

        <div class="chip-row">
          <span class="chip">${ev.camera}</span>
          <span class="chip">${ev.eventSeverity || ""}${ev.eventSeverity ? " • " : ""}${ev.time}</span>
        </div>

        <div class="title">${ev.title}</div>
        <div class="scene">${ev.scene}</div>
        ${objectsDisplay}
      `;

      eventsContainer.appendChild(card);
    }

    setupThumbnailClickHandlers();
  }

  function renderPage() {
    const filtered = applyFilters(lastEvents);
    const total = filtered.length;

    if (!total) {
      renderCards([]);
      pageInfoSpan.textContent = "No results";
      prevPageBtn.disabled = true;
      nextPageBtn.disabled = true;
      return;
    }

    const totalPages = Math.max(1, Math.ceil(total / pageSize));

    if (currentPage > totalPages) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;

    const startIndex = (currentPage - 1) * pageSize;
    const pageEvents = filtered.slice(startIndex, startIndex + pageSize);

    renderCards(pageEvents);

    pageInfoSpan.textContent = `Page ${currentPage} of ${totalPages}`;
    prevPageBtn.disabled = currentPage <= 1;
    nextPageBtn.disabled = currentPage >= totalPages;
  }

  async function loadSingleDay(dateStr) {
    const todayStr = getTodayString();
    const isToday = dateStr === todayStr;

    if (isToday) {
      statusText.textContent = "Building today’s log…";
      const {start, end} = getEpochRangeForDate(dateStr);
      await fetch("/api/webhook/frigate_genai_log", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ydate:dateStr,start,end})
      });
      await new Promise(r=>setTimeout(r,800));
    } else {
      statusText.textContent = "Loading historical log…";
    }

    const fileName = getLogFileName(dateStr);
    const res = await fetch(fileName + "?" + Date.now());
    if (!res.ok) throw new Error(`HTTP ${res.status} for ${fileName}`);

    const raw = await res.text();
    return parseLogContent(raw);
  }

  async function loadSevenDays() {
    statusText.textContent = "Loading last 7 days…";
    const todayStr = getTodayString();
    const allEvents = [];
    let filesLoaded = 0;

    for (let i = 0; i < 7; i++) {
      const dateStr = getOffsetDateString(-i);
      try {
        if (dateStr === todayStr) {
          const events = await loadSingleDay(dateStr);
          allEvents.push(...events);
          filesLoaded++;
        } else {
          const fileName = getLogFileName(dateStr);
          const res = await fetch(fileName + "?" + Date.now());
          if (!res.ok) continue;
          const raw = await res.text();
          const events = parseLogContent(raw);
          allEvents.push(...events);
          filesLoaded++;
        }
      } catch (e) {
        console.warn("Failed to load log for", dateStr, e);
      }
    }

    return { events: allEvents, filesLoaded };
  }

  async function loadLog() {
    try {
      const dateVal = logDateInput.value || getTodayString();

      let events = [];
      let filesLoaded = 0;

      if (rangeMode === "7days") {
        const result = await loadSevenDays();
        events = result.events;
        filesLoaded = result.filesLoaded;
        statusText.textContent = `Loaded ${events.length} events from last 7 days (${filesLoaded} file(s))`;
      } else {
        const dayEvents = await loadSingleDay(dateVal);
        events = dayEvents;
        filesLoaded = 1;
        statusText.textContent = `Loaded ${events.length} events from ${dateVal}`;
      }

      lastEvents = events;
      currentPage = 1;

      updateCameraOptions(events);
      updateSeverityOptions(events);
      updateObjectsOptions(events);

      renderPage();
    }
    catch(err) {
      console.error(err);
      statusText.textContent = "Error";
      emptyMessage.textContent = "Failed to load log(s): " + err.message;
      eventsContainer.innerHTML = "";
      pageInfoSpan.textContent = "";
      prevPageBtn.disabled = true;
      nextPageBtn.disabled = true;
    }
  }

  // Date change => single-day mode
  logDateInput.addEventListener("change", () => {
    rangeMode = "single";
    currentPage = 1;
    loadLog();
  });

  // Quick range buttons
  btnToday.addEventListener("click", () => {
    rangeMode = "single";
    logDateInput.value = getTodayString();
    currentPage = 1;
    loadLog();
  });

  btnYesterday.addEventListener("click", () => {
    rangeMode = "single";
    logDateInput.value = getOffsetDateString(-1);
    currentPage = 1;
    loadLog();
  });

  btn7Days.addEventListener("click", () => {
    rangeMode = "7days";
    logDateInput.value = getTodayString();
    currentPage = 1;
    loadLog();
  });

  // Filters
  cameraFilter.addEventListener("change", () => {
    currentPage = 1;
    renderPage();
  });

  threatFilter.addEventListener("change", () => {
    currentPage = 1;
    renderPage();
  });

  eventSeverityFilter.addEventListener("change", () => {
    currentPage = 1;
    renderPage();
  });

  objectsFilter.addEventListener("change", () => {
    currentPage = 1;
    renderPage();
  });

  pageSizeSelect.addEventListener("change", () => {
    pageSize = parseInt(pageSizeSelect.value, 10) || 12;
    currentPage = 1;
    renderPage();
  });

  prevPageBtn.addEventListener("click", () => {
    if (currentPage > 1) {
      currentPage--;
      renderPage();
    }
  });

  nextPageBtn.addEventListener("click", () => {
    currentPage++;
    renderPage();
  });

  // Initial load: today's single-day log
  window.addEventListener("DOMContentLoaded", () => {
    rangeMode = "single";
    loadLog();
  });
</script>
</body>
</html>
